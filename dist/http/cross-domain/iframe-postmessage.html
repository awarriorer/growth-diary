<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>日常跨域解决方案之(iframe + postMessage) | 知识归纳</title>
    <meta name="description" content="架构师的路上……">
    <link rel="icon" href="/images/icon/uncle.ico">
    
    <link rel="preload" href="/assets/css/7.styles.7753f020.css" as="style"><link rel="preload" href="/assets/js/app.8aed1688.js" as="script"><link rel="preload" href="/assets/js/4.18e242f4.js" as="script"><link rel="prefetch" href="/assets/js/0.d158d61c.js"><link rel="prefetch" href="/assets/js/1.5414fd8f.js"><link rel="prefetch" href="/assets/js/2.9cefcf91.js"><link rel="prefetch" href="/assets/js/3.27c28b33.js"><link rel="prefetch" href="/assets/js/5.b1a110ff.js"><link rel="prefetch" href="/assets/js/6.7c064667.js">
    <link rel="stylesheet" href="/assets/css/7.styles.7753f020.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/" class="home-link router-link-active"><!----><span class="site-name">
      知识归纳
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><!----></div></header><div class="sidebar-mask"></div><div class="sidebar"><!----><!----></div><div class="page"><div class="content"><h3 id="日常跨域解决方案之-iframe-postmessage"><a href="#日常跨域解决方案之-iframe-postmessage" aria-hidden="true" class="header-anchor">#</a> 日常跨域解决方案之(iframe + postMessage)</h3><p>原理：postMessage可以与任意域名之间通信(只要能通信了，其他的就都是浮云了),<br>
类似一个代理，A域名不能直接访问B域名的接口，于是B给A派了一个小弟(pageC.html页面)，然后跟A说，你可以通过快递小哥(postMessage)把你的请求告诉我小弟，然后我小弟会把你想要的结果快递给你~</p><p>代码：<code>http://dev.test.com/post-message.html</code></p><div class="language- extra-class"><pre class="language-text"><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
	&lt;meta charset=&quot;UTF-8&quot;&gt;
	&lt;title&gt;iframe-posMessage示例&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;button id=&quot;but&quot;&gt;执行请求&lt;/button&gt;

	&lt;iframe src=&quot;http://dev.example.com/iframe-postMessage&quot; id=&quot;iframe&quot; frameborder=&quot;0&quot;&gt;&lt;/iframe&gt;
	
	&lt;script type=&quot;text/javascript&quot;&gt;
		window.onload = () =&gt;{
			let but = document.querySelector(&quot;#but&quot;);

			but.onclick = function(){
				let requestOptions = {
					methods: 'get',
					url: 'http://dev.example.com/get-name',
				}

				createRequest(requestOptions, function(res){
					console.log('响应...');
					console.log(res);
				})
			}
		}

		// 初始化请求个数
		window.requestIndex = 0;

		let iframe = window.frames[0];

		// 创建一个请求
		function createRequest(opt, next){
			// 请求次数自增，避免下次请求时回调执行絮乱
			requestIndex++;

			// 回调函数名称
			let funName = 'postMessageBack_' + requestIndex;

			// 把请求标识带过去
			opt.callback = funName;

			// 定义回调名称
			window[funName] = function(res){
				// 执行回调
				next(res);
			}

			let str = JSON.stringify(opt)

			iframe.postMessage(str, '*');
		}

		window.addEventListener(&quot;message&quot;, function(event){
			let data = {};

			if(event.data){
				data = JSON.parse(event.data);
			}

			let callbackName = data.callback;

			if(callbackName){
				delete data.callback;
			}

			// 执行回调
			typeof window[callbackName] === 'function' &amp;&amp; window[callbackName](data);

		}, false);
	&lt;/script&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre></div><p>代码：<code>http://dev.example.com/iframe-postMessage</code></p><div class="language- extra-class"><pre class="language-text"><code>&lt;!DOCTYPE html&gt;
&lt;html lang=&quot;en&quot;&gt;
&lt;head&gt;
	&lt;meta charset=&quot;UTF-8&quot;&gt;
	&lt;title&gt;快递小哥&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
	&lt;script type=&quot;text/javascript&quot;&gt;
		window.onload = () =&gt;{

			window.addEventListener(&quot;message&quot;, function(event){
				let origin = event.origin;
				// 允许访问的白名单
				let whitelist = [
					'http://dev.test.com',
					'http://dev.test2.com',
					'http://dev.test3.com',
				];

				if(whitelist.indexOf(origin) == -1){
					console.log(&quot;不在白名单内~&quot;);
					return;
				}
				
				let requestOpstions = JSON.parse(event.data);

				// 发出请求
				request(requestOpstions, function(res){

					res.callback = requestOpstions.callback;

					let resJson = JSON.stringify(res);

					// 把数据广播出去
					window.parent.postMessage(resJson, origin);
				})

			}, false);

			// 常规请求
			function request(options, next){
				var xhr = new XMLHttpRequest(); 
				var methods = options.methods.toLocaleUpperCase();

				// 异步传输
				xhr.open(methods, options.url, true);

				//发送请求
				xhr.send(null);

				xhr.onreadystatechange = function() {//Call a function when the state changes.
					if(xhr.readyState == XMLHttpRequest.DONE &amp;&amp; xhr.status == 200) {
						let response = xhr.responseText;

						response = JSON.parse(response);

						// 请求结束后,在此处写处理代码
						next(response)
					}
				}
			}

		}

	&lt;/script&gt;

&lt;/body&gt;
&lt;/html&gt;
</code></pre></div><h4 id="小结"><a href="#小结" aria-hidden="true" class="header-anchor">#</a> 小结</h4><ul><li>本质
<ul><li>postMessage跨域通信</li><li>把请求委托给目标域名的页面</li></ul></li><li>缺点
<ul><li>ie8+才支持，而且ie8+&lt;ie10只支持iframe的方式</li></ul></li><li>优点
<ul><li>支持各个类型的请求</li></ul></li></ul></div><div class="page-edit"><!----><!----></div><!----></div></div></div>
    <script src="/assets/js/4.18e242f4.js" defer></script><script src="/assets/js/app.8aed1688.js" defer></script>
  </body>
</html>
